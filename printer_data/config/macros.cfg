
#####################################################################
# Macros
#####################################################################
# [gcode_macro STATUS_READY]
# gcode:
#     # Setzt alle 10 LEDs auf dein dezentes Weiß/Grau
#     SET_LED LED=toolhead_leds RED=0.2 GREEN=0.2 BLUE=0.2 TRANSMIT=1

# [gcode_macro STATUS_BUSY]
# gcode:
#     # Beispiel: Logo rot, Sequins aus
#     SET_LED LED=toolhead_leds RED=0.5 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
#     # ... hier könntest du weitere definieren ...
#     SET_LED LED=toolhead_leds RED=0.5 GREEN=0 BLUE=0 INDEX=8 TRANSMIT=1

# [gcode_macro STATUS_LEVELING]
# gcode:
#     # Alles Orange während des Meshs
#     SET_LED LED=toolhead_leds RED=0.5 GREEN=0.2 BLUE=0 TRANSMIT=1

# [gcode_macro TEST_TOOLHEAD_LEDS]
# description: Testet alle 10 LEDs nacheinander (8 Logo + 2 Sequins)
# gcode:
#     # Erstmal alles aus
#     SET_LED LED=toolhead_leds RED=0 GREEN=0 BLUE=0 TRANSMIT=1
#     G4 P500 # Halbe Sekunde warten
    
#     {% for i in range(1, 11) %}
#         M118 Teste LED Index: {i}
#         # Jede LED einzeln kurz aufleuchten lassen
#         SET_LED LED=toolhead_leds RED=0.3 GREEN=0.3 BLUE=0.3 INDEX={i} TRANSMIT=1
#         G4 P200 # Kurze Pause
#     {% endfor %}
    
#     M118 Test abgeschlossen.
#     # Am Ende alle dezent weiß einschalten
#     SET_LED LED=toolhead_leds RED=0.2 GREEN=0.2 BLUE=0.2 TRANSMIT=1
# [gcode_macro ATTACH_PROBE]
# gcode:
#       {% set F = 4000 %}   
#       SAVE_GCODE_STATE NAME=attach_probe_state
#       T1
#       G90
#       G0 Z14
#       G0 Y60 F{F}
#       G0 X60 Y60 F{F}
#       G0 X-36 Y100 F{F}
#       G0 Y118.5 F{F}
#       G0 X-16 F{F}
#       G0 X60 Y60 F{F}
#       RESTORE_GCODE_STATE NAME=attach_probe_state

[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True

[gcode_macro PID_TUNE_RAPIDO]
description: PID-Tuning unter realen Druckbedingungen (Bett AN, Lüfter AN)
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(245)|float %}
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set FAN_SPEED = params.FAN|default(64)|int %}

    M117 Heatsoak Bett...
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    
    # 1. Homing & Parken
    G28
    DOCK_PROBE 
    G1 X60 Y60 Z15 F3000 # Nah am Bett parken für reale Thermik
    
    # 2. Warten bis Bett bereit ist
    M190 S{BED_TEMP}
    
    # 3. Stabilisierungs-Wartezeit (3 Min), damit die Luft unter der Düse warm ist
    {action_respond_info("Bett bereit. Warte 3 Min auf thermische Stabilisierung...")}
    G4 P180000 
    
    # 4. Kühlung an
    M106 S{FAN_SPEED} 
    
    # 5. Tuning
    {action_respond_info("Starte PID für Extruder: %dC (Bett: %dC)" % (EXTRUDER_TEMP, BED_TEMP))}
    PID_CALIBRATE HEATER=extruder TARGET={EXTRUDER_TEMP} SAMPLES=10
    
    # 6. Shutdown
    M106 S0
    TURN_OFF_HEATERS
    G1 Z50 F3000
    M117 PID fertig! SAVE_CONFIG!

[gcode_macro KLICKY_ULTRA_CHECK]
description: Misst die Abweichung zwischen Docking-Vorgängen
variable_min_z: 999.0
variable_max_z: -999.0
variable_count: 0
variable_goal: 0
gcode:
    {% set iterations = params.ITERATIONS|default(3)|int %}
    SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=min_z VALUE=999.0
    SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=max_z VALUE=-999.0
    SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=count VALUE=0
    SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=goal VALUE={iterations}
    
    G28
    # Startet die verzögerte Schleife
    UPDATE_DELAYED_GCODE ID=_ULTRA_CHECK_TICK DURATION=0.1

[delayed_gcode _ULTRA_CHECK_TICK]
gcode:
    {% set me = printer["gcode_macro KLICKY_ULTRA_CHECK"] %}
    {% if me.count < me.goal %}
        ATTACH_PROBE
        PROBE
        # Übergabe an die Berechnung
        _ULTRA_CHECK_CALC
    {% else %}
        _ULTRA_CHECK_SUMMARY
    {% endif %}

[gcode_macro _ULTRA_CHECK_CALC]
gcode:
    {% set last_z = printer.probe.last_z_result %}
    {% set me = printer["gcode_macro KLICKY_ULTRA_CHECK"] %}
    
    # NEUER FILTER: Wir akzeptieren nur Werte zwischen -1.0 und 1.0
    # Alles was bei 10.0 liegt, wird gnadenlos aussortiert.
    {% if last_z < 1.0 and last_z > -1.0 %}
        {% set new_min = [me.min_z, last_z]|min %}
        {% set new_max = [me.max_z, last_z]|max %}
        SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=min_z VALUE={new_min}
        SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=max_z VALUE={new_max}
        {action_respond_info("Lauf %d: Korrekte Messung bei %.4f" % (me.count + 1, last_z))}
    {% else %}
        {action_respond_info("Lauf %d: FEHLTRIGGER BEI %.4f IGNORIERT" % (me.count + 1, last_z))}
        # Wir ziehen den Count nicht hoch, damit er den Lauf wiederholt? 
        # Nein, wir zählen weiter, damit das Makro nicht unendlich läuft.
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=KLICKY_ULTRA_CHECK VARIABLE=count VALUE={me.count + 1}
    DOCK_PROBE
    UPDATE_DELAYED_GCODE ID=_ULTRA_CHECK_TICK DURATION=0.5

[gcode_macro _ULTRA_CHECK_SUMMARY]
gcode:
    {% set me = printer["gcode_macro KLICKY_ULTRA_CHECK"] %}
    {% set range = me.max_z - me.min_z %}
    {action_respond_info("********** GESAMTAUSWERTUNG **********")}
    {action_respond_info("Gueltige Laeufe: %d" % me.count)}
    {% if me.min_z < 900 %}
        {action_respond_info("Niedrigstes Z: %.4f" % me.min_z)}
        {action_respond_info("Hoechstes Z:   %.4f" % me.max_z)}
        {action_respond_info("STREUUNG (RANGE): %.4f mm" % range)}
        
        {% if range <= 0.005 %}
            {action_respond_info("STATUS: PERFEKT (Referenz-Klasse)")}
        {% elif range <= 0.01 %}
            {action_respond_info("STATUS: SEHR GUT (Absolut stabil)")}
        {% else %}
            {action_respond_info("STATUS: REINIGUNG EMPFOHLEN (Magnet-Check!)")}
        {% endif %}
    {% else %}
        {action_respond_info("FEHLER: Keine gueltigen Messungen gefunden!")}
    {% endif %}
    {action_respond_info("**************************************")}
# [gcode_macro ATTACH_PROBE]
# gcode:
#     {% set F = 3000 %}
    
#     # Homing sicherstellen
#     {% if "xyz" not in printer.toolhead.homed_axes %}
#         G28
#     {% endif %}

#     G90                 ; Absoluter Modus
#     M117 Sammle Probe...

#     # Bewegungsablauf zum Aufsammeln
#     G0 X0 Y80 F{F}      ; Vorposition
#     G0 X0 Y120 F{F}     ; Einfahren ins Dock
#     G0 X25 Y120 F{F}    ; Seitwärts (Probe sichern)
#     G0 X40 Y80 F{F}     ; Freifahren
    
#     M117 Probe bereit.

# [gcode_macro DETACH_PROBE]
# gcode:
#     {% set F = 3000 %}
#     SAVE_GCODE_STATE NAME=detach_state
    
#     G90
#     M117 Lege Probe ab...

#     # Bewegungsablauf zum Ablegen
#     G0 X90 Y90 F{F}     ; Anfahrt
#     G0 X40 Y100 F{F}    ; Zwischenschritt
#     G0 X25 Y120 F{F}    ; Vor das Dock fahren
#     G0 X0 Y120 F{F}     ; In das Dock schieben
#     G4 P500             ; 0,5 Sek. warten zum Einrasten
#     G0 X0 Y90 F{F}      ; Wegfahren (Halterung zieht Probe ab)

#     RESTORE_GCODE_STATE NAME=detach_state
#     M117 Probe sicher im Dock.

# [gcode_macro Z_OFFSET_CALIBRATE]
# description: Holt die Probe und startet die Kalibrierung exakt in der Mitte
# gcode:
#     # 1. Probe holen (nutzt dein bestehendes Macro)
#     ATTACH_PROBE
    
#     # 2. Zur Mitte fahren (Sonde auf 60/60)
#     # Wir nutzen X=60 Y=60 direkt im Befehl, damit Klipper die Offsets verrechnet
#     M117 Fahre zur Mitte für Kalibrierung...
#     PROBE_CALIBRATE X=60 Y=60

# [gcode_macro DETACH_PROBE]
# gcode:
#       {% set F = 4000 %}
#       SAVE_GCODE_STATE NAME=detach_probe_state
#       T1
#       G90
#       G0 Z14
#       G0 Y60 F{F}
#       G0 X60 Y60 F{F}
#       G0 X-16 Y118.5 F{F}
#       G0 X-36 F{F}
#       G0 Y100 F{F} F{F}
#       G0 X60 Y60 F{F}
#       RESTORE_GCODE_STATE NAME=detach_probe_state

[gcode_macro LED_PROUD]
description: Logo Pink/Purple, Nozzle Weiss
gcode:
    # 1. Das Logo (Index 1-8) auf Pink setzen
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=1 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=2 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=3 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=4 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=5 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=6 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=7 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=0.8 GREEN=0.0 BLUE=0.5 INDEX=8 TRANSMIT=0
    
    # 2. Die Nozzle-Sequins (Index 9-10) auf Weiss setzen
    SET_LED LED=toolhead_leds RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=9 TRANSMIT=0
    SET_LED LED=toolhead_leds RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=10 TRANSMIT=1 # TRANSMIT=1 schickt den Befehl erst hier ab

[gcode_macro _CG28]
description: Conditional Homing - Homt nur, wenn Achsen nicht bekannt sind
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

[gcode_macro LEVEL_BED]
gcode:
  _CG28
  BED_SCREWS_ADJUST



# [gcode_macro START_PRINT]
# gcode:
#     {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
#     {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
#     {% set MATERIAL = params.MATERIAL|default("PLA")|string %}
    
#     # Nevermore an bei ABS/ASA
#     {% if MATERIAL in ['ABS', 'ASA', 'eABS', 'eABS+', 'eASA'] %}
#         SET_FAN_SPEED FAN=Nevermore SPEED=1.0
#     {% endif %}



#     G90
#     _CG28
#     CENTER

#     # Den Profi-Soaker aufrufen
#     # RATE=0.3 bedeutet: Er ist fertig, wenn das Bett sich um weniger als 0.3°C pro Minute ändert
#     # SOAKER ist dein Bettsensor (meistens "heater_bed")
#     HEAT_SOAK HEATER='heater_bed' TARGET={BED_TEMP} SOAKER="temperature_sensor Chamber" COMPLETE='SOAKING_COMPLETE' SOAK_TEMP=40 RATE=0.1 TEMP_SMOOTH=6 RATE_SMOOTH=30 TIMEOUT=90 HEATING_REPORT_INTERVAL=10 SOAKING_REPORT_INTERVAL=30

[gcode_macro _CLIENT_RETRACT]
description: Überschreibt Mainsail-Retract ohne Konsolen-Spam
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
    {% set length = params.LENGTH|default(client.retract)|default(1.0)|float %}
    {% set speed = params.SPEED|default(client.speed_retract)|default(35) %}

    # Nur retracten, wenn die Nozzle heiß genug ist - sonst einfach gar nichts tun
    {% if printer.extruder.can_extrude %}
        _CLIENT_EXTRUDE LENGTH=-{length|float|abs} SPEED={speed|float|abs}
    {% endif %}
    
[gcode_macro _SET_FAN_SPEED]
gcode:
    # Dieses Makro wandelt Prozent in den Klipper-Wert (0.0 bis 1.0) um
    {% set PERCENT = params.PERCENT|default(0)|float %}
    # Hier musst du entscheiden: Soll die Nevermore oder der Bauteillüfter drehen?
    # Für den V0.2 macht die Nevermore am meisten Sinn:
    SET_FAN_SPEED FAN=Nevermore SPEED={PERCENT / 100}
    
[gcode_macro PRINT_WARMUP]
description: Homing und Heat Soak Vorbereitung
variable_material: "PLA"
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(190) | float %}
    {% set BED_TEMP = params.BED_TEMP | default(60) | float %}
    {% set MAT = params.MATERIAL | default("PLA") | string | upper %}

    SET_GCODE_VARIABLE MACRO=PRINT_WARMUP VARIABLE=material VALUE='"{MAT}"'
    
    # JETZT AUCH HIER EINE MELDUNG:
    M118 WARMUP: Starte Vorbereitung fuer {MAT}...

    SET_FILAMENT_SENSOR SENSOR=O2_sensor ENABLE=0
    _CG28 
    _SET_FAN_SPEED PERCENT=100
    
    M104 S{EXTRUDER_TEMP * 0.7}
    M140 S{BED_TEMP}

    CENTER

    M190 S{BED_TEMP}

    M117

    ADAPTIVE_HEAT_SOAK BED={bed_temp} SOAKER="temperature_sensor heater_bed"
    
    # Der Soak "schluckt" danach die Konsole
    # HEAT_SOAK HEATER="heater_bed" TARGET={BED_TEMP} SOAKER="temperature_sensor Chamber" COMPLETE="SOAKING_COMPLETE" SOAK_TEMP=40 RATE=0.1 TEMP_SMOOTH=6 RATE_SMOOTH=30 TIMEOUT=90 HEATING_REPORT_INTERVAL=10 SOAKING_REPORT_INTERVAL=20
    
[gcode_macro PRINT_START]
gcode:
    # Parameter laden
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(190) | float %}
    {% set BED_TEMP = params.BED_TEMP | default(60) | float %}
    
    # Hol das gespeicherte Material
    {% set MATERIAL = params.MATERIAL | default(printer["gcode_macro PRINT_WARMUP"].material) | default("PLA") | upper %}

    # FIX für "Printer not homed": Falls Motoren aus waren, nochmal kurz checken
    _CG28

    # Gruppe 1: Volle Fahrt
    # Tipp: Ich habe 'ABS-HS' und 'EABS-HS' ergänzt, da dein Slicer das so schickt
    {% if MATERIAL in ['ABS','ABS+', 'ASA','ASA+', 'EABS', 'ABS-HS', 'EABS-HS', 'EABS+', 'EASA', 'PA', 'PA6', 'PA12', 'PC'] %}
        M118 Material {MATERIAL} erkannt: Nevermore auf 100%
        _SET_FAN_SPEED PERCENT=100

    # Gruppe 2: Mittlere Fahrt
    {% elif MATERIAL in ['PETG', 'CPE', 'FIBERLOGY_CPE'] %}
        M118 Material {MATERIAL} erkannt: Nevermore auf 50%
        _SET_FAN_SPEED PERCENT=50

    # Gruppe 3: Aus
    {% elif MATERIAL in ['PLA', 'PLA+', 'TPU', 'TPE'] %}
        M118 Material {MATERIAL} erkannt: Nevermore aus
        _SET_FAN_SPEED PERCENT=0

    # Fallback
    {% else %}
        M118 Unbekanntes Material {MATERIAL}: Nevermore auf 30%
        _SET_FAN_SPEED PERCENT=30
    {% endif %}


    G28 Z
    Attach_Probe
    M400                  
    G4 P500               
    QUERY_PROBE           
                  
    BED_MESH_CLEAR                   # Altes Mesh aus dem Speicher werfen
    BED_MESH_CALIBRATE ADAPTIVE=1    # Erstellt neues Mesh und aktiviert es als "default"
    
    # HIER LAG DER FEHLER: 
    # KEIN Save_Config! Klipper nutzt das gerade erstellte Mesh automatisch.
    # KEIN Bed_Mesh_Load! Das Mesh ist nach dem Calibrate bereits aktiv.

    Dock_Probe                       # Sonde weg
    
    M118 Heize Nozzle auf Zieltemperatur...
    M109 S{EXTRUDER_TEMP}

    M118 O2S: Aktiviere Filament Sensor...
    SET_FILAMENT_SENSOR SENSOR=O2_sensor ENABLE=1 

    LINE_PURGE
    M117 Drucke {MATERIAL}...

[gcode_macro SOAKING_COMPLETE]
gcode:
    M118 Heat Soak beendet. Starte Druckvorgang...
    # Sicherheits-Homing, falls der Soak lange gedauert hat und Motoren aus sind
    _CG28
    # Falls du möchtest, dass er nach dem Soak automatisch PRINT_START ruft:
    # PRINT_START MATERIAL={printer["gcode_macro PRINT_WARMUP"].material}

# [gcode_macro CONTINUE_PRINT_LOGIC]
# variable_extruder_temp: 190
# gcode:
#     # Dieser Teil wird erst NACH dem Soak ausgeführt
#     M117 Nozzle aufheizen...
#     M109 S{extruder_temp}
#     Smart_Park # Falls du das Makro hast, sonst G1 zum Startpunkt
#     LINE_PURGE
#     M117 Druck startet!

# [gcode_macro SOAK_COMPLETE]
# gcode:
#     # Das wird vom delayed_gcode gerufen
#     CONTINUE_PRINT_LOGIC

# [gcode_macro RESUME_PRINT_FLOW]
# variable_extruder_temp: 190
# gcode:
#     M117 Nozzle aufheizen...
#     M109 S{extruder_temp}
#     M117 Purging...
#     LINE_PURGE
#     M117 Druck startet!

    
[gcode_macro END_PRINT]
gcode:
    # 1. Sicherer Abschluss
    M400                           ; Warten auf alle Bewegungen
    G92 E0                         ; Extruder Null
    G1 E-5.0 F3600                 ; Großer Retract (Rapido-safe)
    
    # 2. Parken (Nutzt deine _CLIENT_VARIABLE X115 Y115)
    _TOOLHEAD_PARK_PAUSE_CANCEL
    
    # 3. Abkühlen
    TURN_OFF_HEATERS
    M107                           ; Bauteillüfter aus
    
    # 4. Nevermore Nachlauf (Filtert noch 10 Min weiter)
    M118 Filter-Nachlauf: 10 Min.
    UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE_TIMER DURATION=600
    
    # 5. Komfort-Funktion: Bett runter
    G90
    G1 Z118 F3000
    
    M117 Druck fertig!
    M84                            ; Motoren aus

#####################################################################
# HILFS-MAKROS & TIMER
#####################################################################

[delayed_gcode STOP_NEVERMORE_TIMER]
gcode:
    SET_FAN_SPEED FAN=Nevermore SPEED=0
    M118 Nevermore automatisch aus.

[gcode_macro CENTER]
gcode:
    _CG28
    G90
    G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } Z{ printer.toolhead.axis_maximum.z/4 } F7200



[gcode_macro _RUN_IDLE_TIMEOUT]
description:  Internal
  Starts if idle timeout has expired
  triggered by klipper
gcode:
  {% if printer.pause_resume.is_paused %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=last_extruder_temp VALUE="{printer.extruder.target}"  
    
    M118 Idle timeout, hotend cooldown

    M104 S0  # cooldown the hotend
    # SET_LED LED="chamber" RED=0 GREEN=0 BLUE=0 WHITE=1 TRANSMIT=1
  {% else %}
    M118 Idle timeout, poweroff
    
    _SHUTDOWN
    M84    

    # SET_LED LED="chamber" RED=0 GREEN=0 BLUE=0 WHITE=0.25 TRANSMIT=1
  {% endif %}  

[gcode_macro _SHUTDOWN]
description: Shutdown the printer
gcode:
  
  G92 E0 # Reset Extruder
  G90 # Reset to absolute mode
  
  TURN_OFF_HEATERS
  M106 S0 # Turn of extruder-fan
  M220 S100 # Reset Speed factor override percentage to default (100%)
  M221 S100 # Reset Extruder flow rate override percentage to default (100%)
  
  M84 # Disable steppers # Solved by RUN_IDLE_TIMEOUT   


[gcode_macro POWER_OFF]
gcode:
  {% set STATE = printer.print_stats.state %}    
  {% set NOCHECK = params.NOCHECK | default(0) %}    
  {% if NOCHECK == "1" or (STATE != "printing" and STATE != "paused") %}
    M118 Wait for cooldown extruder
    SET_HEATER_TEMPERATURE HEATER="extruder"
    TEMPERATURE_WAIT SENSOR="extruder" MAXIMUM=50
      
    SET_PIN PIN=printer_ac VALUE=0   
    
    UPDATE_DELAYED_GCODE ID=_delayed_power_off DURATION=5
  {% else %}
    M118 Still printing or paused
  {% endif %}




# #####################################################################
# # HEAT SOAK LOGIK
# #####################################################################

# [gcode_macro HEAT_SOAK]
# description: heats the bed for a while
# variable_target_temp: 0
# variable_stage: None 
# variable_check_interval: 10
# variable_soak_time_remaining: 0
# variable_total_time_elapsed: 0
# gcode:
#     {% set TARGET = params.TARGET | default(0) | float %}
#     {% set DURATION = (params.DURATION | default(15) | int) * 60 %} 

#     SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_temp         VALUE={ TARGET }
#     SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage                VALUE="'heating'"
#     SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE={ DURATION }
#     SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed  VALUE=0

#     # Bett heizen
#     SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ TARGET }

#     # Homing und Parken (Voron Mitte)
#     _CG28
#     CENTER

#     # M84 ENTFERNT (Wichtig! Damit Achsen nicht verloren gehen)
    
#     UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ check_interval }

#     # PAUSE_BASE friert den START_PRINT hier ein (dein Sidewinder-Schema)
#     PAUSE_BASE

# [delayed_gcode heat_soaker]
# gcode:
#     {% set heat_soak = printer['gcode_macro HEAT_SOAK'] %}
#     {% set total_time_elapsed = heat_soak.total_time_elapsed + heat_soak.check_interval %}
#     SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed VALUE={ total_time_elapsed }

#     {% set stage = heat_soak.stage %}
#     {% if stage == "heating" and printer.heater_bed.temperature >= heat_soak.target_temp %}
#         {% set stage = "soaking" %}
#     {% endif %}

#     {% if stage == "soaking" %}
#         {% set soak_time_remaining = [heat_soak.soak_time_remaining - heat_soak.check_interval, 0] | max %}
#         SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE={ soak_time_remaining }

#         {% if soak_time_remaining == 0 %}
#             {% set stage = "done" %}
#         {% endif %}
#     {% endif %}

#     SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'{ stage }'"

#     {% if stage in ("done", "cancel") %}
#         {% if stage == "cancel" %}
#             {% set stage = "done" %}
#             TURN_OFF_HEATERS
#             M107
#             M117 Soak abgebrochen
#             CANCEL_PRINT
#         {% else %}
#             M117 Soak beendet nach { "%.1fm" | format(total_time_elapsed / 60.0) }
#             RESUME_BASE
#             RESUME_PRINT_FLOW  # <--- Das hier triggert jetzt die Nozzle!
#         {% endif %}

#         SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_temp         VALUE=0
#         SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE=0
#         SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed  VALUE=0
#     {% else %}
#         {% if total_time_elapsed % 90 == 0 %}
#             {% if stage == "heating" %}
#                 M117 Aufheizen... { "%.1fm" | format(total_time_elapsed / 60.0) }
#             {% elif stage == "soaking" %}
#                 M117 Soaken... { "%.1fm" | format(soak_time_remaining / 60.0) } rest
#             {% endif %}
#         {% endif %}
#         UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ heat_soak.check_interval }
#     {% endif %}

# [gcode_macro SKIP_SOAK]
# description: Beendet den Heat Soak sofort und startet den Druck
# gcode:
#     {% if printer['gcode_macro HEAT_SOAK'].stage == "heating" or printer['gcode_macro HEAT_SOAK'].stage == "soaking" %}
#         M118 Soak manuell uebersprungen...
#         SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'done'"
#         UPDATE_DELAYED_GCODE ID=heat_soaker DURATION=1
#     {% else %}
#         M118 Kein aktiver Soak zum Ueberspringen.
#     {% endif %}
# [gcode_macro SET_MATERIAL]
# description: Set values based on material type
# variable_material: ''
# gcode:
#     {% set MATERIAL = params.MATERIAL|default('PLA')|string %} ; Get material type from slicer
#     SET_GCODE_VARIABLE MACRO=SET_MATERIAL VARIABLE=material VALUE='"{MATERIAL}'" ; Save the material type to a variable just because
#     {% if MATERIAL == 'PLA' %} ; If material type is PLA
#         BED_MESH_PROFILE LOAD="pla_mesh" ; Load bed mesh
#         SET_PRESSURE_ADVANCE ADVANCE=0.035 SMOOTH_TIME=0.040 ; Set pressure_advance settings
#         SET_GCODE_OFFSET Z=0 ; Set z_offset
#         SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=2000 ; Set max speed/acceleration
#         SET_INPUT_SHAPER SHAPER_FREQ_X=58.6 SHAPER_FREQ_Y=34.2 SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv ; Set input_shaper
#     {% elif MATERIAL == 'ABS' %} ; If material type is ABS
#         BED_MESH_PROFILE LOAD="abs_mesh" ; Load bed mesh
#         SET_PRESSURE_ADVANCE ADVANCE=0.035 SMOOTH_TIME=0.040 ; Set pressure_advance settings
#         SET_GCODE_OFFSET Z=0 ; Set z_offset
#     {%else %} ; If any other material type
#         BED_MESH_PROFILE LOAD="default" ; Load bed mesh
#         SET_PRESSURE_ADVANCE ADVANCE=0.035 SMOOTH_TIME=0.040 ; Set pressure_advance settings
#         SET_GCODE_OFFSET Z=0 ; Set z_offset
#     {% endif %}

    
[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x %}
        {% if x_min < 0 %}
            {% set x_min = 0 %}
        {% endif %}
    
        {% set y_min = printer.toolhead.axis_minimum.y %}
        {% if y_min < 0 %}
            {% set y_min = 0 %}
        {% endif %}
    
        {% set x_min = x_min + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = y_min + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED
    

[gcode_macro CAN_STATS_BTN]
gcode:
    RUN_SHELL_COMMAND CMD=CAN_STATS
    
# [gcode_macro PAUSE]
# rename_existing: BASE_PAUSE
# gcode:
#     # Parameters
#     {% set z = params.Z|default(10)|int %}                                                   ; z hop amount

#     {% if printer['pause_resume'].is_paused|int == 0 %}
#         SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              ; set z hop variable for reference in resume macro
#         SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    ; set hotend temp variable for reference in resume macro

#         # SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0                                  ; disable filament sensor
#         SAVE_GCODE_STATE NAME=PAUSE                                                          ; save current print position for resume
#         BASE_PAUSE                                                                           ; pause print
#         {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       ; check that zhop doesn't exceed z max
#             G91                                                                              ; relative positioning
#             G1 Z{z} F900                                                                     ; raise Z up by z hop amount
#         {% else %}
#             { action_respond_info("Pause zhop exceeds maximum Z height.") }                  ; if z max is exceeded, show message and set zhop value for resume to 0
#             SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
#         {% endif %}
#         G90                                                                                  ; absolute positioning
#         G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000   ; park toolhead at front center
#         SAVE_GCODE_STATE NAME=PAUSEPARK                                                      ; save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)
#         M104 S0                                                                              ; turn off hotend
#         SET_IDLE_TIMEOUT TIMEOUT=43200                                                       ; set timeout to 12 hours
#     {% endif %}

# [delayed_gcode setdisplayneopixel]
# initial_duration: 1
# gcode:
#         SET_LED LED=display_led RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
#         SET_LED LED=display_led RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
#         SET_LED LED=display_led RED=1 GREEN=0 BLUE=0 INDEX=3 